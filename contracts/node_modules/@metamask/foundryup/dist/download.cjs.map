{"version":3,"file":"download.cjs","sourceRoot":"","sources":["../src/download.ts"],"names":[],"mappings":"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","sourcesContent":["import { request as httpRequest, type IncomingMessage } from 'node:http';\nimport { request as httpsRequest } from 'node:https';\nimport { Stream } from 'node:stream';\nimport { pipeline } from 'node:stream/promises';\n\nimport type { DownloadOptions } from './types';\n\n/**\n * A PassThrough stream that emits a 'response' event when the HTTP(S) response is available.\n */\nclass DownloadStream extends Stream.PassThrough {\n  /**\n   * Returns a promise that resolves with the HTTP(S) IncomingMessage response.\n   *\n   * @returns The HTTP(S) response stream.\n   */\n  async response(): Promise<IncomingMessage> {\n    return new Promise((resolve, reject) => {\n      this.once('response', resolve);\n      this.once('error', reject);\n    });\n  }\n}\n\n/**\n * Starts a download from the given URL.\n *\n * @param url - The URL to download from\n * @param options - The download options\n * @param redirects - The number of redirects that have occurred\n * @returns A stream of the download\n */\nexport function startDownload(\n  url: URL,\n  options: DownloadOptions = {},\n  redirects: number = 0,\n) {\n  const MAX_REDIRECTS = options.maxRedirects ?? 5;\n  const request = url.protocol === 'http:' ? httpRequest : httpsRequest;\n  const stream = new DownloadStream();\n  request(url, options, (response) => {\n    stream.once('close', () => {\n      response.destroy();\n    });\n\n    const { statusCode, statusMessage, headers } = response;\n    // handle redirects\n    if (\n      statusCode &&\n      statusCode >= 300 &&\n      statusCode < 400 &&\n      headers.location\n    ) {\n      if (redirects >= MAX_REDIRECTS) {\n        stream.emit('error', new Error('Too many redirects'));\n        response.destroy();\n      } else {\n        // note: we don't emit a response until we're done redirecting, because\n        // handlers only expect it to be emitted once.\n        pipeline(\n          startDownload(new URL(headers.location, url), options, redirects + 1)\n            // emit the response event to the stream\n            .once('response', stream.emit.bind(stream, 'response')),\n          stream,\n        ).catch(stream.emit.bind(stream, 'error'));\n        response.destroy();\n      }\n    }\n\n    // check for HTTP errors\n    else if (!statusCode || statusCode < 200 || statusCode >= 300) {\n      stream.emit(\n        'error',\n        new Error(\n          `Request to ${url} failed. Status Code: ${statusCode} - ${statusMessage}`,\n        ),\n      );\n      response.destroy();\n    } else {\n      // resolve with response stream\n      stream.emit('response', response);\n\n      response.once('error', stream.emit.bind(stream, 'error'));\n      pipeline(response, stream).catch(stream.emit.bind(stream, 'error'));\n    }\n  })\n    .once('error', stream.emit.bind(stream, 'error'))\n    .end();\n  return stream;\n}\n"]}