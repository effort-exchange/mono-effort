{"version":3,"file":"utils.mjs","sourceRoot":"","sources":["../src/utils.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,YAAY,EAAE,QAAQ,EAAE,2BAA2B;AAC5D,OAAO,EAAE,IAAI,EAAE,gBAAgB;AAE/B,OAAO,EAGL,YAAY,EAGb,oBAAgB;AAEjB;;;;GAIG;AACH,MAAM,CAAC,MAAM,IAAI,GAAG,GAAG,EAAE,CAAC,SAAS,CAAC;AAEpC;;;;;;GAMG;AACH,MAAM,UAAU,2BAA2B,CACzC,eAAuB,IAAI,EAAE;IAE7B,IAAI,YAAY,CAAC,UAAU,CAAC,KAAK,CAAC,EAAE;QAClC,yBAAyB;QACzB,OAAO,YAAY,CAAC,KAAK,CAAC;KAC3B;SAAM,IAAI,YAAY,KAAK,KAAK,EAAE;QACjC,qEAAqE;QACrE,qEAAqE;QACrE,uEAAuE;QACvE,wEAAwE;QACxE,wDAAwD;QACxD,IAAI;YACF,IAAI,QAAQ,CAAC,8CAA8C,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,EAAE;gBACrE,OAAO,YAAY,CAAC,KAAK,CAAC;aAC3B;SACF;QAAC,MAAM;YACN,8DAA8D;SAC/D;KACF;IAED,OAAO,YAAY,CAAC,KAAK,CAAC,CAAC,sCAAsC;AACnE,CAAC;AAED;;;;GAIG;AACH,MAAM,UAAU,GAAG,CAAC,OAAe;IACjC,OAAO,CAAC,GAAG,CAAC,eAAe,OAAO,EAAE,CAAC,CAAC;AACxC,CAAC;AAED;;;;;;GAMG;AACH,MAAM,UAAU,UAAU,CAAC,OAAe;IACxC,IAAI;QACF,OAAO,YAAY,CAAC,OAAO,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,iBAAiB;KAC/E;IAAC,OAAO,KAAc,EAAE;QACvB,MAAM,GAAG,GAAG,6BAA6B,OAAO;;;wEAGoB,CAAC;QACrE,IAAI,KAAK,YAAY,KAAK,EAAE;YAC1B,KAAK,CAAC,OAAO,GAAG,GAAG,GAAG,OAAO,KAAK,CAAC,OAAO,EAAE,CAAC;YAC7C,MAAM,KAAK,CAAC;SACb;QACD,MAAM,IAAI,cAAc,CAAC,CAAC,IAAI,KAAK,CAAC,GAAG,CAAC,EAAE,KAAK,CAAC,CAAC,CAAC;KACnD;AACH,CAAC;AAED;;;;;GAKG;AACH,MAAM,UAAU,YAAY,CAC1B,KAAc;IAEd,OAAO,CACL,KAAK,YAAY,KAAK,IAAI,MAAM,IAAI,KAAK,IAAI,OAAO,KAAK,CAAC,IAAI,KAAK,QAAQ,CAC5E,CAAC;AACJ,CAAC;AAED;;;;;;;;GAQG;AACH,MAAM,UAAU,kBAAkB,CAChC,SAAgC,EAChC,cAAwB,EACxB,UAAwB;IAExB,IAAI,CAAC,SAAS,EAAE;QACd,OAAO,IAAI,CAAC;KACb;IAED,MAAM,GAAG,GAAG,GAAG,cAAc,IAAI,UAAU,EAAW,CAAC;IACvD,OAAO;QACL,SAAS,EAAE,SAAS,CAAC,SAAS;QAC9B,QAAQ,EAAE,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,MAAM,CACjD,CAAC,GAAG,EAAE,CAAC,IAAI,EAAE,MAAM,CAAC,EAAE,EAAE;YACtB,GAAG,CAAC,IAAc,CAAC,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;YAClC,OAAO,GAAG,CAAC;QACb,CAAC,EACD,EAA4B,CAC7B;KACF,CAAC;AACJ,CAAC","sourcesContent":["import { execFileSync, execSync } from 'node:child_process';\nimport { arch } from 'node:os';\n\nimport {\n  type Checksums,\n  type PlatformArchChecksums,\n  Architecture,\n  type Binary,\n  type Platform,\n} from './types';\n\n/**\n * No Operation. A function that does nothing and returns nothing.\n *\n * @returns `undefined`\n */\nexport const noop = () => undefined;\n\n/**\n * Returns the system architecture, normalized to one of the supported\n * {@link Architecture} values.\n *\n * @param architecture - The architecture string to normalize (e.g., 'x64', 'arm64')\n * @returns The normalized architecture value\n */\nexport function normalizeSystemArchitecture(\n  architecture: string = arch(),\n): Architecture {\n  if (architecture.startsWith('arm')) {\n    // if `arm*`, use `arm64`\n    return Architecture.Arm64;\n  } else if (architecture === 'x64') {\n    // if `x64`, it _might_ be amd64 running via Rosetta on Apple Silicon\n    // (arm64). we can check this by running `sysctl.proc_translated` and\n    // checking the output; `1` === `arm64`. This can happen if the user is\n    // running an amd64 version of Node on Apple Silicon. We want to use the\n    // binaries native to the system for better performance.\n    try {\n      if (execSync('sysctl -n sysctl.proc_translated 2>/dev/null')[0] === 1) {\n        return Architecture.Arm64;\n      }\n    } catch {\n      // Ignore error: if sysctl check fails, we assume native amd64\n    }\n  }\n\n  return Architecture.Amd64; // Default for all other architectures\n}\n\n/**\n * Log a message to the console.\n *\n * @param message - The message to log\n */\nexport function say(message: string) {\n  console.log(`[foundryup] ${message}`);\n}\n\n/**\n * Get the version of the binary at the given path.\n *\n * @param binPath - Path to the binary executable\n * @returns The `--version` reported by the binary\n * @throws If the binary fails to report its version\n */\nexport function getVersion(binPath: string): Buffer {\n  try {\n    return execFileSync(binPath, ['--version']).subarray(0, -1); // ignore newline\n  } catch (error: unknown) {\n    const msg = `Failed to get version for ${binPath}\n\nYour selected platform or architecture may be incorrect, or the binary may not\nsupport your system. If you believe this is an error, please report it.`;\n    if (error instanceof Error) {\n      error.message = `${msg}\\n\\n${error.message}`;\n      throw error;\n    }\n    throw new AggregateError([new Error(msg), error]);\n  }\n}\n\n/**\n * Type guard to check if an error has a code property.\n *\n * @param error - The error to check\n * @returns True if the error has a code property\n */\nexport function isCodedError(\n  error: unknown,\n): error is Error & { code: string } {\n  return (\n    error instanceof Error && 'code' in error && typeof error.code === 'string'\n  );\n}\n\n/**\n * Transforms the CLI checksum object into a platform+arch-specific checksum\n * object.\n *\n * @param checksums - The CLI checksum object\n * @param targetPlatform - The build platform\n * @param targetArch - The build architecture\n * @returns Platform and architecture specific checksums or null if no checksums provided\n */\nexport function transformChecksums(\n  checksums: Checksums | undefined,\n  targetPlatform: Platform,\n  targetArch: Architecture,\n): PlatformArchChecksums | null {\n  if (!checksums) {\n    return null;\n  }\n\n  const key = `${targetPlatform}-${targetArch}` as const;\n  return {\n    algorithm: checksums.algorithm,\n    binaries: Object.entries(checksums.binaries).reduce(\n      (acc, [name, record]) => {\n        acc[name as Binary] = record[key];\n        return acc;\n      },\n      {} as Record<Binary, string>,\n    ),\n  };\n}\n"]}