{"version":3,"file":"index.mjs","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["#!/usr/bin/env -S node --require \"./node_modules/tsx/dist/preflight.cjs\" --import \"./node_modules/tsx/dist/loader.mjs\"\n\nimport { createHash } from 'node:crypto';\nimport { readFileSync } from 'node:fs';\nimport type { Dir } from 'node:fs';\nimport {\n  copyFile,\n  mkdir,\n  opendir,\n  rm,\n  symlink,\n  unlink,\n} from 'node:fs/promises';\nimport { homedir } from 'node:os';\nimport { dirname, join, relative } from 'node:path';\nimport { cwd, exit } from 'node:process';\nimport { parse as parseYaml } from 'yaml';\n\nimport { extractFrom } from './extract';\nimport { parseArgs, printBanner } from './options';\nimport type { Checksums, Architecture, Binary } from './types';\nimport { Extension, Platform } from './types';\nimport {\n  getVersion,\n  isCodedError,\n  noop,\n  say,\n  transformChecksums,\n} from './utils';\n\n/**\n * Determines the cache directory based on the .yarnrc.yml configuration.\n * If global cache is enabled, returns a path in the user's home directory.\n * Otherwise, returns a local cache path in the current working directory.\n *\n * @returns The path to the cache directory\n */\nexport function getCacheDirectory(): string {\n  let enableGlobalCache = false;\n  try {\n    const configFileContent = readFileSync('.yarnrc.yml', 'utf8');\n    const parsedConfig = parseYaml(configFileContent);\n    enableGlobalCache = parsedConfig?.enableGlobalCache ?? false;\n  } catch (error) {\n    // If file doesn't exist or can't be read, default to local cache\n    if ((error as NodeJS.ErrnoException).code === 'ENOENT') {\n      return join(cwd(), '.metamask', 'cache');\n    }\n    // For other errors, log but continue with default\n    console.warn(\n      'Warning: Error reading .yarnrc.yml, using local cache:',\n      error,\n    );\n  }\n  return enableGlobalCache\n    ? join(homedir(), '.cache', 'metamask')\n    : join(cwd(), '.metamask', 'cache');\n}\n\n/**\n * Generates the URL for downloading the Foundry binary archive.\n *\n * @param repo - The GitHub repository (e.g., 'foundry-rs/foundry')\n * @param tag - The release tag (e.g., 'v1.0.0')\n * @param version - The version string\n * @param platform - The target platform (e.g., Platform.Linux)\n * @param arch - The target architecture (e.g., 'amd64')\n * @returns The URL for the binary archive\n */\nexport function getBinaryArchiveUrl(\n  repo: string,\n  tag: string,\n  version: string,\n  platform: Platform,\n  arch: string,\n): string {\n  const ext = platform === Platform.Windows ? Extension.Zip : Extension.Tar;\n  return `https://github.com/${repo}/releases/download/${tag}/foundry_${version}_${platform}_${arch}.${ext}`;\n}\n\n/**\n * Checks if binaries are already in the cache. If not, downloads and extracts them.\n *\n * @param url - The URL to download the binaries from\n * @param binaries - The list of binaries to download\n * @param cachePath - The path to the cache directory\n * @param platform - The target platform\n * @param arch - The target architecture\n * @param checksums - Optional checksums for verification\n * @returns A promise that resolves to the directory containing the downloaded binaries\n */\nexport async function checkAndDownloadBinaries(\n  url: URL,\n  binaries: Binary[],\n  cachePath: string,\n  platform: Platform,\n  arch: Architecture,\n  checksums?: Checksums,\n): Promise<Dir> {\n  let downloadedBinaries: Dir;\n  try {\n    say(`checking cache`);\n    downloadedBinaries = await opendir(cachePath);\n    say(`found binaries in cache`);\n  } catch (e: unknown) {\n    say(`binaries not in cache`);\n    if ((e as NodeJS.ErrnoException).code === 'ENOENT') {\n      say(`installing from ${url.toString()}`);\n      // directory doesn't exist, download and extract\n      const platformChecksums = transformChecksums(checksums, platform, arch);\n      await extractFrom(url, binaries, cachePath, platformChecksums);\n      downloadedBinaries = await opendir(cachePath);\n    } else {\n      throw e;\n    }\n  }\n  return downloadedBinaries;\n}\n\n/**\n * Installs the downloaded binaries by creating symlinks or copying files.\n *\n * @param downloadedBinaries - The directory containing the downloaded binaries\n * @param BIN_DIR - The target directory for installation\n * @param cachePath - The path to the cache directory\n * @returns A promise that resolves when installation is complete\n */\nexport async function installBinaries(\n  downloadedBinaries: Dir,\n  BIN_DIR: string,\n  cachePath: string,\n): Promise<void> {\n  for await (const file of downloadedBinaries) {\n    if (!file.isFile()) {\n      continue;\n    }\n    const target = join(file.parentPath, file.name);\n    const path = join(BIN_DIR, relative(cachePath, target));\n\n    // compute the relative path from where the symlink will be created\n    // to the target file, so that it works even if the project is moved\n    // (like in some CI environments)\n    const relativeTarget = relative(dirname(path), target);\n\n    // create the BIN_DIR paths if they don't exists already\n    await mkdir(BIN_DIR, { recursive: true });\n\n    // clean up any existing files or symlinks\n    await unlink(path).catch(noop);\n    try {\n      // create new symlink\n      await symlink(relativeTarget, path);\n    } catch (e) {\n      if (!(isCodedError(e) && ['EPERM', 'EXDEV'].includes(e.code))) {\n        throw e;\n      }\n      // symlinking can fail if it's a cross-device/filesystem link, or for\n      // permissions reasons, so we'll just copy the file instead\n      await copyFile(target, path);\n    }\n    // check that it works by logging the version\n    say(`installed - ${getVersion(path).toString()}`);\n  }\n}\n\n/**\n * Downloads and installs Foundry binaries based on command-line arguments.\n * If the command is 'cache clean', it removes the cache directory.\n * Otherwise, it downloads and installs the specified binaries.\n *\n * @returns A promise that resolves when the operation is complete\n */\nexport async function downloadAndInstallFoundryBinaries(): Promise<void> {\n  const parsedArgs = parseArgs();\n\n  const CACHE_DIR = getCacheDirectory();\n\n  if (parsedArgs.command === 'cache clean') {\n    await rm(CACHE_DIR, { recursive: true, force: true });\n    say('done!');\n    exit(0);\n  }\n\n  const {\n    repo,\n    version: { version, tag },\n    arch,\n    platform,\n    binaries,\n    checksums,\n  } = parsedArgs.options;\n\n  printBanner();\n  const bins = binaries.join(', ');\n  say(`fetching ${bins} ${version} for ${platform} ${arch}`);\n\n  const BIN_ARCHIVE_URL = getBinaryArchiveUrl(\n    repo,\n    tag,\n    version,\n    platform,\n    arch,\n  );\n  const BIN_DIR = join(cwd(), 'node_modules', '.bin');\n\n  const url = new URL(BIN_ARCHIVE_URL);\n  const cacheKey = createHash('sha256')\n    .update(`${BIN_ARCHIVE_URL}-${bins}`)\n    .digest('hex');\n  const cachePath = join(CACHE_DIR, cacheKey);\n\n  const downloadedBinaries = await checkAndDownloadBinaries(\n    url,\n    binaries,\n    cachePath,\n    platform,\n    arch,\n    checksums,\n  );\n\n  await installBinaries(downloadedBinaries, BIN_DIR, cachePath);\n\n  say('done!');\n}\n"]}